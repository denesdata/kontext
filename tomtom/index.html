<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -- szekelydata -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-57335320-4"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'UA-57335320-4');
  </script>

  <!-- Use correct character set. -->
  <meta charset="utf-8">
  <!-- Tell IE to use the latest, best version. -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!-- Make the application on mobile take up the full browser screen and disable user scaling. -->
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <title>Most congested cities of the world | Kontext</title>
  <meta name="description"
    content="Most congested cities of the world ðŸš— based on TomTom's 2019 Traffic Index #dataviz #cesiumjs #cesium #tomtom @csaladenes" />
  <meta name="keywords"
    content="csaladenes, d3.js, data visualization, infographic, d3plus, d3, cesium, cesiumjs, map, interactivemap, data visualization, mit oec, mit, mit atlas, macro connections, tomtom, gps, congestion, global cities, city, population" />
  <meta property="og:image" content="https://blog.csaladen.es/tomtom/tomtom.png" />
  <meta property="og:image:width" content="807px" />
  <meta property="og:image:height" content="665px" />
  <meta property="twitter:image" content="https://blog.csaladen.es/tomtom/tomtom.png" />
  <meta property="og:description"
    content="Most congested cities of the world ðŸš— based on TomTom's 2019 Traffic Index #dataviz #cesiumjs #cesium #tomtom @csaladenes" />
  <meta property="twitter:description"
    content="Most congested cities of the world ðŸš— based on TomTom's 2019 Traffic Index #dataviz #cesiumjs #cesium #tomtom @csaladenes" />
  <meta property="og:title" content="Most congested cities of the world | Kontext" />
  <meta property="twitter:title" content="Most congested cities of the world | Kontext" />
  <meta http-equiv="content-Type" content="text/html; charset=utf-8" />
  <meta property="og:url" content="https://blog.csaladen.es/tomtom" />
  <meta property="twitter:url" content="https://blog.csaladen.es/tomtom" />
  <meta property="og:site_name" content="Kontext" />
  <meta property="fb:admins" content="100943737036023614165" />
  <link rel="shortcut icon" href="https://blog.csaladen.es/favicon.ico" />
  <link rel="publisher" href="https://plus.google.com/106181965793093327960" />


  <script src="https://cesium.com/downloads/cesiumjs/releases/1.63/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.63/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <script src="https://d3js.org/d3-collection.v1.min.js"></script>
  <script src="https://d3js.org/d3-selection.v1.min.js"></script>
  <script src="https://d3js.org/d3-dispatch.v1.min.js"></script>
  <script src="https://d3js.org/d3-dsv.v1.min.js"></script>
  <script src="https://d3js.org/d3-request.v1.min.js"></script>
  <script src="https://d3js.org/d3-color.v1.min.js"></script>
  <script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
  <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
  <script src="https://d3js.org/d3-scale.v3.min.js"></script>
  <style>
    html,
    body,
    #cesiumContainer {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
  </style>
</head>

<body>
  <div id="cesiumContainer"></div>
  <script>
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJiZWYxMTQwMC1iZjRiLTQ2ZmQtYTk0MS0zNGI3MjI1MzRlZTYiLCJpZCI6MTY5MjcsInNjb3BlcyI6WyJhc3IiLCJnYyJdLCJpYXQiOjE1NzEzMjU3ODd9.InYGD_zyuB-tFLaIahXGyU5SoYyd5tjI3EaInQ5zrOs';
    d3.csv("dcp.csv", function (rawdata) {
      var data = Object.values(rawdata).slice(0, -1)

      // console.log(data)

      var czml = [{
        "id": "document",
        "name": "KlÃ­macsÃ­kok",
        "version": "1.0"
      }];
      
      // var colors = d3.scaleSequential(d3.interpolateOranges).domain([-1, 8])
      var colors = d3.scaleSequential(d3.interpolateTurbo).domain([-2, 8])
      // var colors = d3.scaleSequential(d3.interpolateSpectral).domain([9,-1])
      // var colors = d3.scaleSequential(d3.interpolateRdYlGn).domain([9, -2])
      // var colors = d3.scaleSequential(d3.interpolateRainbow).domain([7, -6])
      
      function namer(name) {
        return (name == 'Katowice urban area' ? 'Katowice' :
          name == 'Dallas-Fort Worth' ? 'Dallas' :
            name == 'Moscow region (oblast)' ? 'Moscow' :
              name)
      }

      data.forEach(function (d, i) {
        // console.log(i, d)
        var lon = parseFloat(d['lat']);
        var lat = parseFloat(d['lon']);
        var shape = d['Rank by filter']
        var name = namer(d['City']);
        var radius = parseInt(Math.pow(parseFloat(d['pop']), 0.72) + 5000);
        // var radius = 10000;
        var height = (Math.pow(Math.max(parseInt(d['Congestion Level2']) - 12, 3), 1.5)) * 2000;
        // var height = 5000
        var segment_height = 60000;
        var n = parseInt(height / segment_height);
        for (var i = 0; i < n + 1; i++) {
          if (i == n) {
            this_height = height - i * segment_height
          }
          else {
            this_height = Math.min(height, segment_height)
          }
          
          czml.push({
            "id": String(shape) +'#'+ String(i),
            "name": name + i,
            "description": '<a style="text-decoration:none;" target="_blank" href="' + d['a'] + '"><table><tr><td style="font-size:40px;"><b>' + parseInt(d['Rank by filter']) + '&nbsp;</b></td><td>' +
              '<b>' + name + '</b> has a population of <b>' + Math.round(d['pop'] / 10000, 2) / 100.0 + '</b> million people.<br>The ' +
              'average congestion level of the city is <b>' + d['Congestion Level2'] + '%</b>.' +
              '</td></tr><tr><td colspan="2">' +
              '<br>In the morning rush hour is ' + d['morning'] + '%, while in the evening is ' + d['eve'] + '%.<br>' +
              'Your typical 1 hour trip takes ' + parseInt((parseInt(d['eve']) + 100) * 0.6) + ' minutes instead.<br><br>' +
              name + ' is <b>#' + parseInt(d['Rank by filter']) + '</b> most congested in the world' + (parseInt(d['eu']) ? ' and <b>#' + parseInt(d['eu']) + '</b> in EU.' : '.') +
              '</td></tr></table></a>',
            "position": {
              "cartographicDegrees": [lat, lon, this_height / 2 + i * segment_height]
            },
            "cylinder": {
              "length": this_height,
              "topRadius": radius,
              "bottomRadius": radius,
              "material": {
                "solidColor": {
                  "color": {
                    "rgba": [d3.rgb(colors(i)).r, d3.rgb(colors(i)).g, d3.rgb(colors(i)).b, 255]
                  }
                }
              }
            }
          })
        }
        czml.push({
          "id": shape + 'l',
          "name": name,
          "description": '<a style="text-decoration:none;" target="_blank" href="' + d['a'] + '"><table><tr><td style="font-size:40px;"><b>' + parseInt(d['Rank by filter']) + '&nbsp;</b></td><td>' +
            '<b>' + name + '</b> has a population of <b>' + Math.round(d['pop'] / 10000, 2) / 100.0 + '</b> million people.<br>The ' +
            'average congestion level of the city is <b>' + d['Congestion Level2'] + '%</b>.' +
            '</td></tr><tr><td colspan="2">' +
            '<br>In the morning rush hour is ' + d['morning'] + '%, while in the evening is ' + d['eve'] + '%.<br>' +
            'Your typical 1 hour trip takes ' + parseInt((parseInt(d['eve']) + 100) * 0.6) + ' minutes instead.<br><br>' +
            name + ' is <b>#' + parseInt(d['Rank by filter']) + '</b> most congested in the world' + (parseInt(d['eu']) ? ' and <b>#' + parseInt(d['eu']) + '</b> in EU.' : '.') +
            '</td></tr></table></a>',
          "position": {
            "cartographicDegrees": [lat, lon, height + radius / 2]
          },
          "label": {
            "fillColor": { "rgba": [241, 241, 241, 255] },
            "font": Math.min(Math.max(12, radius / 3000), 30) + "pt Arial",
            "horizontalOrigin": "CENTER",
            "eyeOffset": {
              "cartesian": [0, 0, 0]
            },
            "translucencyByDistance": {
              "nearFarScalar": [Math.max(radius * 90, 3000000), 1.0, Math.max(radius * 110, 4000000), 0.0]
            },
            "outlineColor": { "rgba": [0, 0, 0, 255] },
            "outlineWidth": 1,
            "style": "FILL_AND_OUTLINE",
            // "style": "FILL",
            "text": name
          }
        })
      })

      var viewer = new Cesium.Viewer('cesiumContainer', {
        imageryProvider: new Cesium.OpenStreetMapImageryProvider({
          url: 'https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_all/'
          // url: 'https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/'
        }),
        baseLayerPicker: false,
        shouldAnimate: true,
        animation: false,
        // geocoder: false,
        homeButton: false,
        timeline: false,
        navigationInstructionsInitiallyVisible: false
      });

      //Enable lighting based on sun/moon positions
      // viewer.scene.globe.enableLighting = true;
      // viewer.clock.clockRange = Cesium.ClockRange.LOOP_STOP; //Loop at the end
      // viewer.clock.multiplier = 1000;
      // viewer.infoBox.frame.sandbox = "allow-same-origin allow-top-navigation allow-pointer-lock allow-popups allow-forms allow-scripts";

      // imageryProvider: new Cesium.UrlTemplateImageryProvider({
      //     url: 'https://maps.wikimedia.org/osm-intl/{z}/{x}/{y}.png?lang=hu'
      //   }),

      var dataSourcePromise = Cesium.CzmlDataSource.load(czml);
      viewer.dataSources.add(dataSourcePromise);
      // viewer.zoomTo(dataSourcePromise);
      viewer.camera.flyTo({
        destination: Cesium.Cartesian3.fromDegrees(14, 29, 3000000.0),
        orientation: {
          heading: Cesium.Math.toRadians(-4.0),
          pitch: Cesium.Math.toRadians(-60.0),
          roll: 0.0
        }
      });

      // var layers = viewer.scene.imageryLayers;
      // layers.addImageryProvider(new Cesium.SingleTileImageryProvider({
      //   url: '../klima/szekelydata_klimacsikok.png',
      //   rectangle: Cesium.Rectangle.fromDegrees(16.5, 44.5, 21.0, 45.5)
      // }));

      d3.select(".cesium-widget-credits").insert("a", ":first-child")
        .attr("class", "cesium-credit-imageContainer")
        .text('fd')
        .attr("href", "https://szekelydata.csaladen.es")
        .attr("target", "_blank")
        .html("<img style='margin-bottom:-8px;margin-left:8px;height:40px;' src='//szekelydata.csaladen.es/klima/szd_logo.png' alt='szÃ©kelydata' title='szÃ©kelydata' />")
      d3.select(".cesium-widget-credits").insert("a", ":first-child")
        .attr("class", "cesium-credit-imageContainer")
        .text('fd')
        .attr("href", "https://blog.csaladen.es")
        .attr("target", "_blank")
        .html("<img style='height:32px;margin-bottom:-2px;margin-left:8px;' src='https://blog.csaladen.es/favicon.ico' alt='Kontext blog' title='Kontext blog' />")
      d3.select(".cesium-widget-credits").insert("a", ":first-child")
        .attr("class", "cesium-credit-imageContainer")
        .text('fd')
        .attr("rel", "author")
        .attr("href", "https://csaladen.es")
        .attr("target", "_blank")
        .html("<img style='margin-bottom:-2px;margin-left:8px;height:30px;' src='https://csaladen.es/favicon.ico' alt='by DÃ©nes Csala' title='by DÃ©nes Csala' />")
      d3.select(".cesium-viewer-toolbar").insert("div")
        .attr("class", "cesium-button cesium-toolbar-button material-icons")
        .style("padding-left", "0px")
        .style("padding-top", "0px")
        .append('a')
        .text("")
        .attr('target', '_blank')
        .attr("title", "Help - TomTom 2019 Traffic Index")
        .style('font-size', '20px')
        .attr('href', 'https://www.tomtom.com/en_gb/traffic-index/ranking/')
        .append('img')
        .attr('src', 'https://www.tomtom.com/favicon.ico')
        .attr('width', '30px')
      d3.select(".cesium-viewer-cesiumWidgetContainer").append("div")
        .style("position", "absolute")
        .style("top", "10px")
        .style("left", "10px")
        .style("width", "400px")
        .style("color", "#eee")
        .attr("id", "subs")
      d3.select("#subs").append("div")
        .attr("class", "cesium-viewer-cesiumWidgetContainer")
        .html('<div style="font-size:20px;">Most congested cities of the world</div>' +
          '<div style="font-size:15px;margin-top:5px;">ðŸš— based on <b>TomTom' + "'s " +
          '<a style="color:#eee;text-decoration:none" href="https://www.tomtom.com/en_gb/traffic-index/ranking/">2019 Traffic Index</a></b></div>' +
          '<div>' +
          '<svg height="20" width="300"><line x1="0" y1="15" x2="300" y2="15" style="stroke:#eee;stroke-width:1" />' +
          '</div>' +
          '<div>' +
          '<svg height="45" width="25"><circle cx="15" cy="20" r="5" stroke="#ccc" stroke-width="0" fill="#eee" /></svg>' +
          '<svg height="45" width="40"><circle cx="20" cy="20" r="10" stroke="#ccc" stroke-width="0" fill="#eee" /></svg>' +
          '<svg height="45" width="40"><circle cx="20" cy="20" r="15" stroke="#ccc" stroke-width="0" fill="#eee" /></svg>' +
          '<div style="font-size:15px;margin-top:-35px;margin-left:120px">larger population</div>' +
          '</div>' +
          '<div>' +
          '<svg height="50" width="26"><circle cx="13" cy="30" r="10" stroke="#2aabee" stroke-width="0" fill="#2aabee" /></svg>' +
          '<svg height="50" width="26"><circle cx="13" cy="30" r="10" stroke="#6afd6a" stroke-width="0" fill="#6afd6a" /></svg>' +
          '<svg height="50" width="26"><circle cx="13" cy="30" r="10" stroke="#feb927" stroke-width="0" fill="#feb927" /></svg>' +
          '<svg height="50" width="26"><circle cx="13" cy="30" r="10" stroke="#c2270a" stroke-width="0" fill="#c2270a" /></svg>' +
          '<div style="font-size:15px;margin-top:-31px;margin-left:120px">more congestion</div>' +
          '</div>')
    })

    // ["#6e40aa","#b83cb0","#f6478d","#ff6956","#f59f30","#c4d93e","#83f557","#38f17a","#19d3b5","#29a0dd","#5069d9","#6e40aa"]
    // ["#23171b","#4860e6","#2aabee","#2ee5ae","#6afd6a","#c0ee3d","#feb927","#fe6e1a","#c2270a","#900c00"]

  </script>
</body>

</html>